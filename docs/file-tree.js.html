<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>file-tree.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>

<body>

    <input type="checkbox" id="nav-trigger" class="nav-trigger" />
    <label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

    <label for="nav-trigger" class="overlay"></label>

    <nav>
        <h2><a href="index.html">Home</a></h2>
        <h3>Classes</h3>
        <ul>
            <li><a href="ManifestEntry.html">ManifestEntry</a>
                <ul class='methods'>
                    <li data-type='method'><a href="ManifestEntry.html#hashFieldPath">hashFieldPath</a></li>
                </ul>
            </li>
        </ul>
        <h3>Global</h3>
        <ul>
            <li><a href="global.html#extract">extract</a></li>
        </ul>
    </nav>

    <div id="main">

        <h1 class="page-title">file-tree.js</h1>

        <section>
            <article>
                <pre class="prettyprint source linenums"><code>"use strict";

/**
 * @file A {@link processor} function that converts the manifest database into a file tree
 * of json files each containing a single entry from the database allowing it to be served
 * statically.
 */

let fs = require('fs');
let mkdirp = require('./lib/utils').mkdirp;

/**
 * Save a manifest entry to a file.
 * @private
 */
function saveJson(path, entry) {
    return new Promise((resolve, reject) => {
        fs.writeFile(path, JSON.stringify(entry.data, null, 2), 'utf-8', err => {
            if (err) reject(err);
            else resolve();
        });
    });
}

module.exports = function(rootPath, writeLimit) {

    let queue = [];
    let workers = [];
    let writes = 0;
    let limit = writeLimit || 100;

    /**
     * The processor function to pass to extract.
     */
    function processor(lang, entry) {
        let dir = `${rootPath}/${lang}/${entry.tablename}`;
        let file = `${dir}/${entry.hashKey}.json`;
        queue.push({
            dir: dir,
            file: file,
            entry: entry
        });
        write();
    }

    /**
     * Start another write worker if the limit has not been reached.
     */
    function write() {
        if (writes >= limit) return;
        writes++;
        let data = queue.shift()
        workers.push(doWrite(data));
    }

    /**
     * The write worker function, takes an entry from the queue and
     * writes it to a file. Once the write is complete the next item
     * in the queue is taken. Stops when the queue is empty.
     */
    function doWrite(data) {
        return mkdirp(data.dir)
            .then(() => saveJson(data.file, data.entry))
            .then(() => {
                let next = queue.shift();
                if (next) {
                    return doWrite(data);
                }
                else {
                    writes--;
                }
            });
    }

    /**
     * Waits for all the worker operations to complete.
     */
    function waitDone() {
        return Promise.all(workers);
    }

    return {
        processor: processor,
        waitDone: waitDone
    };
}
</code></pre>
            </article>
        </section>

    </div>

    <br class="clear">

    <footer>
        Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Sat Feb 18 2017 15:53:23 GMT+0900 (JST) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
    </footer>

    <script>
        prettyPrint();
    </script>
    <script src="scripts/linenumber.js"></script>
</body>

</html>